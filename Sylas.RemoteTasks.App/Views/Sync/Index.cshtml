@{
    ViewData["Title"] = "Http Request Processor ...";
}

<div class="container">
    <h1>HTTP请求处理器</h1>
    <div class="row">
        <div class="col-md-6">
            <form id="search-form">
                <div class="mb-3">
                    <label for="search-input" class="form-label">关键字</label>
                    <input type="text" class="form-control" id="search-input">
                </div>
                <button type="submit" class="btn btn-primary">搜索</button>
            </form>
        </div>
    </div>
    <div id="tableContainer">
        <table>
            <tr class="align">

            </tr>
        </table>
    </div>
</div>

@section Scripts{
    <script>
        $(function () {
            const apiUrl = "Sync/GetHttpRequestProcessors";
            
            const tableId = 'tableProcessors';

            const tableParentSelector = "#tableContainer";
            const ths = [
                { name: 'title', title: '标题' },
                { name: 'name', title: '名称/编码' },
                { name: 'url', title: 'Url地址' },
                { name: 'stepCirleRunningWhenLastStepHasData', title: '步骤循环', enumValus: [ false, true ] },
                { name: 'remark', title: '备注', width: 200, showPart: 12 },
                // 操作栏
                { name: '', title: '操作', type: 'button', tmpl: `<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="collapse" href="#collapse${tableId}{{id}}" role="button" aria-expanded="true" aria-controls="collapse${tableId}{{id}}">步骤</button>
                        <button type="button" class="btn btn-primary btn-sm" data-table-id="${tableId}" data-id="{{id}}" data-fetch-url="Sync/GetHttpRequestProcessors" data-update-url="Sync/UpdateHttpRequestProcessor" data-method="POST" onclick="showUpdatePannel(this)">修改</button>
                        <button type="button" class="btn btn-primary btn-sm" data-table-id="${tableId}" data-id="{{id}}" data-delete-url="Sync/DeleteHttpRequestProcessor" data-method="POST" onclick="deleteData(this)">删除</button>`
                }
            ]
            const idFieldName = "id";

            /**
             * 创建表 - Steps (一张表中的所有数据对应一个Processor)
             */
            function onProcessorsDataLoaded(row) {
                const processorId = row[idFieldName];
                const tableStepsId = `tableStepsForProcessor${processorId}`;
                let steps = row.steps;
                if (!steps || !(steps.length) || $(`#${tableStepsId}`).length) {
                    return;
                }
                createTable(
                    "Sync/GetHttpRequestProcessorSteps", 1, 1000,
                    tableStepsId,
                    tableParentSelector,
                    [
                        { name: 'parameters', title: '执行参数' },
                        { name: 'dataContextBuilder', title: '数据上下文构建器', showPart: 12 },
                        { name: 'remark', title: '备注', width: 200, showPart: 8 },
                        { name: 'presetDataContext', title: '预设数据上下文' },
                        { name: 'HttpRequestProcessorId', title: 'HTTP处理器', type: 'dataSource|dataSourceApi=Sync/GetHttpRequestProcessors|displayField=title' },
                        { name: '', title: '操作', type: 'button', tmpl: `<button type="button" class="btn btn-primary btn-sm" data-bs-toggle="collapse" href="#collapse${tableStepsId}{{id}}" role="button" aria-expanded="true" aria-controls="collapse${tableStepsId}{{id}}">数据处理器</button>
                                <button type="button" class="btn btn-primary btn-sm" data-table-id="${tableStepsId}" data-id="{{id}}" data-fetch-url="Sync/GetHttpRequestProcessorSteps" data-update-url="Sync/UpdateHttpRequestProcessorStep" data-method="POST" onclick="showUpdatePannel(this)">修改</button>
                                <button type="button" class="btn btn-primary btn-sm" data-table-id="${tableStepsId}" data-id="{{id}}" data-delete-url="Sync/DeleteHttpRequestProcessorStep" data-method="POST" onclick="deleteData(this)">删除</button>`
                        }
                    ],
                    idFieldName,
                    [
                        {
                            fieldName: 'processorId',
                            compareType: '=',
                            value: processorId.toString()
                        }
                    ],
                    steps,
                    null,
                    // wrapper 每一张表关联的是Processor表的某一行数据
                    `<div id="collapse${tableId}${row[idFieldName]}" class="collapse" aria-labelledby="${tableParentSelector}" data-bs-parent="#accordion"><div class="card-body">{{tableHtml}}</div></div>`
                    // addModalSettings
                    , { modalType: 'add', url: 'Sync/AddHttpRequestProcessorStep', 'method': 'POST' }
                );


                createTableDataHandlers(steps, tableStepsId);
            }

            /**
             * 创建表 - DataHandler(一张表中的所有数据对应一个Step)
             * steps 某一条Processor记录对应的所有步骤, 这些steps将在一张表中展示
             * tableStepsId steps所在表的Id
             */
            function createTableDataHandlers(steps, tableStepsId) {
                for (let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    let loadingData = step.dataHandlers;
                    const stepId = step[idFieldName];
                    const tableDataHandlersId = `tableDataHandlersForStep${stepId}`;
                    if (loadingData && (loadingData.length) && !$(`#${tableDataHandlersId}`).length) {
                        createTable(
                            "Sync/GetHttpRequestProcessorStepDataHandlers", 1, 1000,
                            tableDataHandlersId,
                            tableParentSelector,
                            [
                                { name: 'dataHandler', title: '数据处理器' },
                                { name: 'parametersInput', title: '参数' },
                                { name: 'remark', title: '备注', width: 200, showPart: 8 }
                            ],
                            idFieldName,
                            [
                                {
                                    fieldName: 'stepId',
                                    compareType: '=',
                                    value: stepId.toString()
                                }
                            ],
                            loadingData,
                            null,
                            // wrapper 每一张表关联的是Steps表的某一行数据
                            `<div id="collapse${tableStepsId}${stepId}" class="collapse" aria-labelledby="${tableParentSelector}" data-bs-parent="#accordion"><div class="card-body">{{tableHtml}}</div></div>`
                            // addModalSettings
                            , { modalType: 'add', url: 'Sync/AddHttpRequestProcessorStepDataHandler', 'method': 'POST' }
                        );
                    }
                }
            }

            // Processors
            createTable(apiUrl, 1, 10, tableId, tableParentSelector, ths, idFieldName, null, null, onProcessorsDataLoaded, ''
                , { modalType: 'add', url: 'Sync/AddHttpRequestProcessor', 'method': 'POST' }
            )
        });
    </script>
}
